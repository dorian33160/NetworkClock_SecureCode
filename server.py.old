import datetime
import socket
import select

#Menu qui affiche les options disponibles (afficher l'heure, afficher la date, afficher les deux, changer la date et l'heure)
def menu_offline():
    print("1 - choisir le format")
    print("2 - Afficher la date et l'heure")
    print("3 - Changer la date et l'heure")
    print("4 - Quitter\n\n")

def menu_online(client_socket):
    client_socket.send("1 - choisir le format\n".encode())
    client_socket.send("2 - Afficher la date et l'heure\n".encode())
    client_socket.send("3 - Changer la date et l'heure\n".encode())
    client_socket.send("4 - Quitter\n\n".encode())

################################ FONCTION ONLINE ###############################

#Fonction qui demande au client de choisir le format de la date et de l'heure
def get_format_online(client_socket):
    client_socket.send("Choisissez le format de la date (ex: %d/%m/%Y): \n".encode())
    date_format = client_socket.recv(1024).decode()
    client_socket.send("Choisissez le format de l'heure (ex: %H:%M:%S): \n".encode())
    heure_format = client_socket.recv(1024).decode()
    return date_format, heure_format

def get_time_online(client_socket, date_format, heure_format):
    maintenant = datetime.datetime.now()
    date = maintenant.strftime(date_format)
    heure = maintenant.strftime(heure_format)
    client_socket.send(date.encode())
    client_socket.send('{}\n'.format(heure).encode())
    

def start_server(host, port):
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.bind((host, port))
    server_socket.listen(5)  # Limite le nombre de connexions en attente à 5

    server_socket.setblocking(0)  # Définit le socket en mode non bloquant

    print("Serveur en écoute sur {}:{}".format(host, port))

    date_format = ""
    heure_format = ""

    inputs = [server_socket]  # Liste des sockets à surveiller

    while True:
        # Utilise select pour vérifier si de nouvelles connexions sont disponibles
        readable, _, _ = select.select(inputs, [], [])

        for sock in readable:
            if sock == server_socket:
                # Nouvelle connexion entrante
                client_socket, address = server_socket.accept()
                print("Connexion de {}\n".format(address))
                inputs.append(client_socket)  # Ajoute le nouveau socket à la liste des sockets surveillés
                client_socket.send("Choisissez une option: \n\n".encode())
                menu_online(client_socket)  # Afficher le menu une fois au début
            else:
                # Données disponibles sur un socket existant
                choix = sock.recv(1024).decode('utf-8').strip()
                if choix == "1":
                    date_format, heure_format = get_format_online(sock)
                    menu_online(sock)  # Envoyer le menu après chaque commande
                elif choix == "2":
                    if date_format == "" or heure_format == "":
                        date_format = "%d/%m/%Y"
                        heure_format = "%H:%M:%S"
                    get_time_online(sock, date_format, heure_format)
                    menu_online(sock)  # Envoyer le menu après chaque commande
                # elif choix == "3":
                #     change_time()
                elif choix == "4":
                    sock.close()
                    inputs.remove(sock)  # Retire le socket de la liste des sockets surveillés

###########################################################################

################################ FONCTION OFFLINE ###############################

def get_format_offline():
    date_format = input("Choisissez le format de la date (ex: %d/%m/%Y): ")
    heure_format = input("Choisissez le format de l'heure (ex: %H:%M:%S): ")
    return date_format, heure_format

def get_time_offline():
    date_format = ""
    heure_format = ""
    while True:
        menu_offline()
        choix = input("Choisissez une option: \n")
        if choix == "1":
            date_format, heure_format = get_format_offline()
        elif choix == "2":
            if date_format == "" or heure_format == "":
                date_format = "%d/%m/%Y"
                heure_format = "%H:%M:%S"
            maintenant = datetime.datetime.now()
            date = maintenant.strftime(date_format)
            heure = maintenant.strftime(heure_format)
            print(date)
            print(heure)
        #elif choix == "3":
        #    change_time()
        elif choix == "4":
            break
        else:
            print("Choix invalide\n")

###########################################################################
    
def main():
    get_time_offline()
    host = "localhost"
    port = 12345
    start_server(host, port)

if __name__ == "__main__":
    main()